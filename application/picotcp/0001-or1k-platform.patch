From 7736eb0a07b849fa58a9cfaba85b23fdb7e504d7 Mon Sep 17 00:00:00 2001
From: shiloxyz <shiloxyz@q6600arch>
Date: Thu, 3 Nov 2016 18:22:07 +0300
Subject: [PATCH] or1k platform

---
 Makefile                     |  4 ++
 include/arch/pico_or1k_gcc.h | 97 ++++++++++++++++++++++++++++++++++++++++++++
 include/pico_config.h        |  2 +
 3 files changed, 103 insertions(+)
 create mode 100644 include/arch/pico_or1k_gcc.h

diff --git a/Makefile b/Makefile
index 8ce14e6..75d3a51 100644
--- a/Makefile
+++ b/Makefile
@@ -164,6 +164,10 @@ ifeq ($(ARCH),atmega128)
   CFLAGS+=-Wall -mmcu=atmega128 -DAVR
 endif
 
+ifeq ($(ARCH),or1k)
+  CFLAGS+=-DOR1K
+endif
+
 ifeq ($(ARCH),none)
   CFLAGS+=-DARCHNONE
 endif
diff --git a/include/arch/pico_or1k_gcc.h b/include/arch/pico_or1k_gcc.h
new file mode 100644
index 0000000..3f580b1
--- /dev/null
+++ b/include/arch/pico_or1k_gcc.h
@@ -0,0 +1,97 @@
+/*********************************************************************
+   PicoTCP. Copyright (c) 2012-2015 Altran Intelligent Systems. Some rights reserved.
+   See LICENSE and COPYING for usage.
+
+ *********************************************************************/
+#ifndef _INCLUDE_PICO_OR1K_GCC
+#define _INCLUDE_PICO_OR1K_GCC
+
+#include <stdint.h>
+#include <stdlib.h>
+#include <string.h>
+#include "pico_constants.h"
+
+#include "mem_managment.h"
+
+/* monotonically increasing tick,
+ * typically incremented every millisecond in a systick interrupt */
+extern volatile unsigned int pico_ms_tick;
+
+#define dbg(...)
+
+#ifdef PICO_SUPPORT_PTHREAD
+    #define PICO_SUPPORT_MUTEX
+#endif
+
+#ifdef PICO_SUPPORT_RTOS
+    #define PICO_SUPPORT_MUTEX
+
+extern void *pico_mutex_init(void);
+extern void pico_mutex_lock(void*);
+extern void pico_mutex_unlock(void*);
+extern void *pvPortMalloc( size_t xSize );
+extern void vPortFree( void *pv );
+
+    #define pico_free(x) vPortFree(x)
+    #define free(x)      vPortFree(x)
+
+static inline void *pico_zalloc(size_t size)
+{
+    void *ptr = pvPortMalloc(size);
+
+    if(ptr)
+        memset(ptr, 0u, size);
+
+    return ptr;
+}
+
+static inline pico_time PICO_TIME_MS()
+{
+    return pico_ms_tick;
+}
+
+static inline pico_time PICO_TIME()
+{
+    return pico_ms_tick / 1000;
+}
+
+static inline void PICO_IDLE(void)
+{
+    pico_time now = PICO_TIME_MS();
+    while(now == PICO_TIME_MS()) ;
+}
+
+#else /* NO RTOS SUPPORT */
+
+    #ifdef MEM_MEAS
+        #define pico_free(x)    free_sys(x)
+        #define pico_zalloc(x)  zalloc_sys(x)
+    #else
+/* Use plain C-lib malloc and free */
+        #define pico_free(x) free(x)
+static inline void *pico_zalloc(size_t size)
+{
+    void *ptr = malloc(size);
+    if(ptr)
+        memset(ptr, 0u, size);
+
+    return ptr;
+}
+    #endif
+
+static inline pico_time PICO_TIME_MS(void)
+{
+    return (pico_time)pico_ms_tick;
+}
+
+static inline pico_time PICO_TIME(void)
+{
+    return (pico_time)(PICO_TIME_MS() / 1000);
+}
+
+inline void PICO_IDLE(void);
+
+#endif /* IFNDEF RTOS */
+
+#endif  /* _INCLUDE_PICO_OR1K_GCC */
+
diff --git a/include/pico_config.h b/include/pico_config.h
index 3e5047f..432789b 100644
--- a/include/pico_config.h
+++ b/include/pico_config.h
@@ -210,6 +210,8 @@ static inline uint64_t long_long_be(uint64_t le)
 # include "arch/pico_esp8266.h"
 #elif defined MT7681
 # include "arch/pico_generic_gcc.h"
+#elif defined OR1K
+# include "arch/pico_or1k_gcc.h"
 #elif defined FAULTY
 # include "../test/pico_faulty.h"
 #elif defined ARCHNONE
-- 
2.10.1

